<?php
class VulnerabilityDAO {
    
    public static function insertVulnerability (Vulnerability $vuln){
        $sql = new Sql();
        $sql->query("insert into vulnerability ( id, name, severity, host_id, scan_id, plugin_id,scanner_id ) 
                                        values (:ID,:NAME,:SEVERITY,:HOST_ID,:SCAN_ID,:PLUGIN_ID,:SCANNER_ID ) ",array(
                                               ":ID"=>$vuln->getId(),
                                               ":NAME"=>$vuln->getName(),
                                               ":SEVERITY"=>$vuln->getSeverity(),
                                               ":HOST_ID"=>$vuln->getHost_id(),
                                               ":SCAN_ID"=>$vuln->getScan_id(),
                                               ":PLUGIN_ID"=>$vuln->getPlugin_id(),
                                               ":SCANNER_ID"=>$vuln->getScanner_id()   
        ));
    }
    
    public static function getVulnerabiliiesFromHostname ($hostname){
        $sql = new Sql();
        $result=$sql->query("call sp_getScansFromHost ( :HOSTNAME )",array(
                                               ":HOSTNAME"=>$hostname));
        $returnValue =array("modification"=>"","critical"=>"","high"=>"","medium"=>"","low"=>"","info"=>"");
        
        foreach ($result as $row){
            $returnValue["modification"] = "'".gmdate("d-m-Y",(int)$row['modification'])."',".$returnValue["modification"];
            $returnValue["critical"] = $row['critical'].",".$returnValue["critical"];
            $returnValue["high"]     = $row['high'].",".$returnValue["high"];
            $returnValue["medium"]   = $row['medium'].",".$returnValue["medium"];
            $returnValue["low"]      = $row['low'].",".$returnValue["low"];
            $returnValue["info"]     = $row['info'].",".$returnValue["info"];
        }
        return $returnValue;
    }
    public static function getAllVulnerabilitiesFromScan ($scan_id,$scanner_id){
        $sql = new Sql();
        $result=$sql->query("call getAllVulnsNamesFromScan ( :SCAN_ID , :SCANNER_ID)",array(
            ":SCAN_ID"=>$scan_id,
            ":SCANNER_ID"=>$scanner_id
        ));
        return $result;
    }

    public static function getAllHostsVulnerable ($scan_id,$scanner_id,$name){
        $sql = new Sql();
        $result=$sql->query("call getAllHostsVulnerable ( :SCAN_ID , :SCANNER_ID , :NAME)",array(
            ":SCAN_ID"=>$scan_id,
            ":SCANNER_ID"=>$scanner_id,
            ":NAME"=>$name
        ));
        return $result;
    }
    
    
    
    
    
    
    
    
    
    
    
    
    
    
}

?>